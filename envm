#!/bin/bash
# Author: lukasjoc
# Desc: Handles initialization of all scripts
set -u

for script in "$ENVM"/scripts/*; do
	source "$script"
done

if [[ -z "$ENVM_WDIR" ]]; then
  echo "could not evalulate ENVM_WDIR environment variable."
fi

if [[ -z "$ENVM_WDIR" ]]; then
	if [[ ! -d "$ENVM_WDIR" ]]; then
  	echo "could not find working directory as requested in ENVM_WDIR"
	fi
fi

# Message on SHELL start
figlet "Hello, $USER" || echo "Hello, $USER"
neofetch || true
fortune || true
##########

# automatic update looking for the value in ./cache/start_epoch.dat
if [[ $ENVM_AUTO_UPDATE_DAYS -le 1 ]]; then
	if [ -z "${ENVM+x}" ]; then
		dat_file="$HOME/.cache/envm/start_epoch.dat"

		if [ ! -d "$HOME/.cache/envm" ]; then
			mkdir -p "$HOME/.cache/envm"
		fi

  	if [ ! -f "$dat_file" ]; then
   		date +%s > "$dat_file"
  	fi

  	declare -i update_epoch=$(( 60 * 60 * 24 * "$ENVM_AUTO_UPDATE_DAYS" + $(cat "$dat_file") ))
  	if [[ "$(date +%s)" -ge "$update_epoch" ]]; then
    	date +%s > "$dat_file"
			envmupdate
  	fi
	else
		echo "could not find envm source directory"
	fi
fi

